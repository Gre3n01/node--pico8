pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
-- treasurelight
-- by john mickevich
-- chunk variables (for map paging, but only one chunk for now)
chunk_x = 0
chunk_y = 0

-- var
can_talk = true
active_npc = nil

-- lumo (player)
lumo = {
  x = 48, y = 48,
  sprs = {0, 1}, -- animation frames
  anim = 0,      -- animation timer
  frame = 1,     -- current frame
  w = 8, h = 8
}


-- wall function

-- these are your walls

wall_tiles = {
  [84]=true, [85]=true, [86]=true,
  [100]=true, [101]=true, [102]=true,
  [116]=true, [117]=true, [118]=true
}

function is_wall(x, y)
  local tile = mget(x, y)
  return wall_tiles[tile]
end

-- npc table
npcs = {
  {
    name="morbina",
    title="the bone witch",
    faction="cult of the skull",
    x=64, y=40,
    sprs={4,5},
    anim=0,
    frame=1,
    quest="skull"
  },
  {
    name="veylor",
    title="the death herald",
    faction="remnant",
    x=32, y=80,
    sprs={4,5},
    anim=0,
    frame=1,
    quest="crypt"
  },
  {
    name="lyselle",
    title="the crystal seer",
    faction="shardbound",
    x=96, y=80,
    sprs={4,5},
    anim=0,
    frame=1,
    quest="shards"
  }
}

-- main update function
function _update()
  update_lumo()
  update_npcs()
  check_npc_touch()
end

-- main draw function
function _draw()
  cls()
  draw_map_chunk()
  draw_npcs()
  draw_lumo()
  draw_dialogue()
end

-- update lumo movement and animation
function update_lumo()
  local moved = false
  local nx, ny = lumo.x, lumo.y

  if btn(0) then nx -= 1 moved = true end -- left
  if btn(1) then nx += 1 moved = true end -- right
  if btn(2) then ny -= 1 moved = true end -- up
  if btn(3) then ny += 1 moved = true end -- down

  -- check collision (use center of lumo's sprite)
  local tx = flr((nx + 4) / 8)
  local ty = flr((ny + 4) / 8)
  if not is_wall(tx, ty) then
    lumo.x, lumo.y = nx, ny
  end

  -- animation
  if moved then
    lumo.anim += 1
    if lumo.anim > 10 then
      lumo.anim = 0
      lumo.frame = 3 - lumo.frame
    end
  else
    lumo.frame = 1
    lumo.anim = 0
  end
end

-- update npc animation
function update_npcs()
  for npc in all(npcs) do
    npc.anim += 1
    if npc.anim > 20 then
      npc.anim = 0
      npc.frame = 3 - npc.frame
    end
  end
end

-- check if lumo touches any npc
function check_npc_touch()
  local touching = false
  for npc in all(npcs) do
    if is_touching(lumo, npc) then
      touching = true
      if can_talk and not active_npc then
        active_npc = npc
        can_talk = false
      end
    end
  end
  if not touching then
    active_npc = nil
    can_talk = true
  end
end

-- check overlap between two objects
function is_touching(a, b)
  return abs(a.x - b.x) < 8 and abs(a.y - b.y) < 8
end

-- draw current map chunk
function draw_map_chunk()
  map(chunk_x*16, chunk_y*16, 0, 0, 16, 16)
end

-- draw all npcs
function draw_npcs()
  for npc in all(npcs) do
    spr(npc.sprs[npc.frame], npc.x, npc.y)
  end
end

-- draw lumo
function draw_lumo()
  spr(lumo.sprs[lumo.frame], lumo.x, lumo.y)
end

-- draw dialogue if touching npc
function draw_dialogue()
  if active_npc then
    rectfill(8, 96, 120, 120, 1)
    print(active_npc.name..", "..active_npc.title, 12, 100, 7)
    print("("..active_npc.faction..")", 12, 108, 6)
    print(active_npc.quest, 12, 116, 7)
    print("move to cose", 60, 116, 6)
    -- close dialogue if lumo moves away
    if not is_touching(lumo, active_npc) then
      active_npc = nil
      can_talk = true
    end
  end
end

__gfx__
00000000000000000000006600000066000000000000000000000000000000000000004400000044011110000000000000000000000000000110000000000000
00666606000000000044440400000004000666600000000004444400000000000555540400000404001ee1000111100000111100000000000111110001100000
0066660600666606004fff04004444040006fff000066660044fff000444440005fff4000555540011111110001ee100001fff0000111100001fff0001111100
00f060060066660600f0f004004fff04000f0f000006fff004f0f000044fff000f0f004005fff0400eefff001111111000f0f000001fff0000f0f000001fff00
00ffff0400f0600600ffff0400f0f004000ffff0000f0f0044ffff0004f0f0000ffff0400f0f00400ef0f0000eefff0000ffff0000f0f000001fff0000f0f000
0600006f06ffff040600006f06ffff6f0040004f004ffff04d0004f444ffff00400004f04ffff4f0eeffff00eef0f0000400004004ffff4003111130001fff00
0f6666000f00006f0f6666040f00000400f4440400f444044fddd0444d0004f4f4444040f0000040e10000f0eeffff000f4444f00f0000f00f3333f003111130
0040040000400400004004040040040400400404004004040ddddd004fddd04405005040050050400f1111000f1111f00010010000100100001001000f3333f0
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044000000000000044440000000000
000000000000000005000050000000000440000000000000004444000000000001111100000000000666600000000000004444000004400000ffff0000444400
0044440000000000055555500500005004444400044000000f4fff0000444400111fff00011111000666600006666000004fff000044440000f0f00000ffff00
004fff0000444400005f5f0005555550004fff40044444000ff0f0f00f4fff0011f0f000111fff000f0600000666600000f0f000004fff0000ffff0000f0f000
00f0f000004fff000040f000005f5f000040f000004fff4004ffff000ff0f0f011ffff0011f0f0000fff66600f06000000ffff0000f0f000ff00000000ffff00
0044440000f0f000004fff000040f000004fff000040f0000300003004ffff001d0000d011ffffd0600066606fff66600300003000ffff00ff2ff2ffff0000ff
0f0440f0004444000f0040f0004fff000f0000f0004fff000f3333f0030000301f0dd0f01f0dd0f0f6606660f66066600f3333f00f0000f0004444ffff4444ff
005005000f0440f0005005000f0040f0002002000f0000f0004004000040040000dddd0000dddd00040046000400460000400400004004000040040000400400
00f0f0f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d606600000000
0ff00f0000f0f0f0000000000004040000000000000000000000000000000000000000000000000000000000000000000000000000000000066660d6006d6000
000f44000ff00f0000040400000444400000000000000000007e0000000000000000000000000000000000000000000011000011001111000c0c006006666066
40040420400f440044444440444440f50000000000000000007e0000007e000007090900700000000000000000000000dd1111dd111010110cccc0600c0c00d6
4444444044440420444440f5444444ff0f0f0f000f0f0f0000071700007e0000900999909009090000030300000000000d1010d01d1111d100cc0c600cccc060
4244400042444440444444ff44444550f4f4f400f4f4f40070077700700717000999090009999990003030300003030000111100000000000dddd06000cc0060
404040004040400044444550444445500f4224000f4224000757700007577700099977710999090003bbbbb0033030300000000000000000c0ddd060c0dddc60
00000000000000004500404045004040f42ff0f0f42ff0f007707000077070000909090009097771033bbb30033bbb3000000000000000000ddd00000ddd0060
0000000000000000000000000000000003333044000000000000000000000000000000060000000600000000000000000022230000000000009d9099009d9000
0000000000000000003003000000000033707044033330440066660000000000006666060000000600000000000000000020300000222300099990d909999099
000000000000000000333300003003003370704433707044006060000066660000606004006666040022230000000000002233000020300006060090060600d9
00300300000000000030300000333300037770403370704400666607006060070066660400606004002030000022230000333300002233000666609006666090
00333300003003000033330000303000003330400377704000066074006666740006600400666604003333000020300033000000003333000066069000660090
00303000003333000300003003333330330003303033304000600704006007040060066400600664020000000033330033233233330000330dddd0900dddd690
004444000030300003444430030000303444404034444330060670400606704006066004060660040344442002000020004444333344443360ddd09060ddd090
00300300004444000030030000300300030030000300304000674400006744000060060400600604004004300340043000400400004004000ddd00000ddd0090
000000000000000000000000000000000000000000000000000000000222000000000060000b3000000000000000000000000000000000000000000000000000
000000000000000000000300070030000d00000000000400040000002000200000000606000330000004000000bbb300b3300000000000000000050000050000
0000000000000000000030307e700000ddd00d00000004000300040000f00000000000f000b33300000040000bb3333033300000000000000000000000505000
000000000000000000300033070007000d00ddd00000030033040400000000000006600000333300004040000b3333303030b330000040000000000000050000
00000000000030000303003003007e70ddd00d00040003300303030000022200006666000b333330002440400b33333004003330000404000500000000000000
000003000030303000033000000007300300ddd00300030003000300002000200600006003300330000442000030030000003030000004400000055000500000
000000000000000000030000003003000000030003030300000003000000f000000ff00000044000000240000004400000000400040004000000055000000050
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000
00000000000000000000000011111111066666666666666666666660604404066666000000006666000000333300000000000000000000000000000000000000
0000000111001110011111000100001066666666666666666666666604440440666600000000666600033b3b33b3300000000000000400000000000000000000
0001111000110001100001100022220066000000000000000000006604440440000000000000000003b3b33333bb333000000000000400000000000000000000
0110000111111111111110102222222266505550555055505550556604440440555066600666055533b3bb3b33333b3300000000000000000000000004644640
110111111111111111111010224444226650555055505550555055660404044055506660066605553333333b33b33b3300b0b000000400000000000000099000
10111111111111111111110044000044660000000000000000000066044404400000000000000000b3b33bbbbbb3bb3b0b3b3300000400000444440004000040
1011111111111111111111000401104066555555555555555555556604440440555555555555555533bbb040040bbb3300838000000400000040400004444440
10111111111111111111101010111101660000000000000000000066000000000000000000000000bb000444444000bb0b303300000000000000000000000000
01011111111111111111110100111000660000000000000000000066066666600000000000000000000000000000000004644640000220000000000000000000
01011111111111111111110101000100660000005550555000000066666666660660000005500000000000000000000002222220002442000000000000000000
10111111111111111111101010111010660000005550555000000066660000660650500005505500088088000000060002222220004224000000600000000800
10111111111111111111101010111101660000000000000000000066660000660000000005505500080888000000600000000000002222000000660000008000
10111111111111111111101010111101660000005555555500000066660000660000000000000000008880000406000002000020002442000006000000088000
10111111111111111111110110011101660000000000000000000066660000660000066600505550000800000040000004000040004004000660006000089800
01011111111111111111110101100010660000000000000000000066666666660050065500005550000000000404000004444440004004000060000000499940
01011111111111111111110100011100660000000000000000000066066666600000000000000000000000000000000000000000000440000000000000040400
01011111111111111111110102222200660000000000000000000066600000060000000000000000000000000044440011111111000000000000000000000000
01011111111111111111110104222401660000000000000000000066000000006550555605500550044444400000000011111111000000000000000000000000
10111111111111111111101004222401660000000000000000000066400000046550555605000050640000400088880011111111000030000000000000660000
10111111111111111111010004222401660000000000000000000066400000046000000600055000040060400088880011111111000400000000000000660600
10111111111111111111010004222401660000000000000000000066400000046055555600055000040606000088880011133111444444440066600044464644
10111111111111111111010004222401660000000000000000000066400000046000000605000050640666000088880011933111444424420006000004060604
01000011011000110000100004222401666666666666666666666666400000046550555605500550044444400008800011133311222222440060600004040404
00111100100111001111000002222200066666666666666666666660400000046550555600000000000000000000000011111111000000000000000000000000
88288288882882880000008888288288880000000000000000000a000a00a0a00303003003000300000000000000000000000000222222222000000222222222
882888888888828800088288882882888828800000b00b0000a0a90009a09a900080038008308038030303030000000044444444200000002000000200000002
8828828888288288082888888888828888888280043443400494494009949a900232232002322230029222900224424044444444204444442000000244444402
8828828888288888882882888828888888288288000000000000000000a0a0a00000000000003000000000000000000044444444204444442000000244444402
8888888888888288888882888828828888888288000000000a000a0004949a900300003000008330000000000000000044444444204444442000000244444402
8828822222288288882888888888888888288888000000b0090909a00a9a99908030030800800380303030300000000044444444204444442000000244444402
88222040040222888828828888288288882882880b44434009444940099999900232232002322320092229200422424000000000200000002000000200000002
22000444444000220000000000000000000000000000000000000000000000000000000000000000000000000000000066666666206666662000000266666602
00000088880000000000000000000000000000005000000530000003000000000000000000000000000000000400040022222222200000002000000200000002
00088288882880000000000000000000000000000000000000000000000000000000000000000000000000000404040420000002200000002000000200000002
08288888882888800000000000000000000000000000000000000000000000000000000000000000000000000404040420000002200000002000000200000002
8828828888888288882888880077600000aa90000000000000000000000000000000000000000000000000000004000420000002200000002000000200000002
8888888888288288882882880070600000a090000000000000000000000000000000000000000000000000000400040020000002200000002000000200000002
88288222222882888888888800666000009990000000000000000000000000000000000000000000000000000404040420000002200000002000000200000002
88222040040222888828828800000000000000000000000000000000000000000000000000000000000000000404040420000002200000002000000200000002
22000444444000220000000000000000000000005000000530000003000000000000000000000000000000000004000422222222200000002222222200000002
22222222222002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000002
00000000000440000000000000000000000000000000000000000000000000000000000000000000000000004000000000000004200000000000000000000002
44444444404444040000000000000000000000000000000000000000000000000000000000000000000000004000000000000004200000000000000000000002
40044004404444040004644000000000000000000000000000000000000000000000000000000000000000002044000000004402200000000000000000000002
40044004404444040006004000000000000000000000000000000000000000000000000000000000000000000044000000004400200000000000000000000002
44444444404404040004060600000000000000000000000000000000000000000000000000000000000000000022044004402200200000000000000000000002
00000000004444000004009000000000000000000000000000000000000000000000000000000000000000000000044004400000200000000000000000000002
66666666604444060004066600000000000000000000000000000000000000000000000000000000000000000000022002200000222222222222222222222222
22222222000000000004000000000000000000000000000000000000000000000000000000000000077777000000000000000000222222222222222222222222
00000000000000000004000000000000000000004444444466666666000000000000000000000000077777004440444000000000200000000000000000000002
44444444000600000004000000000000000000004444444466666666000000000040000000000400022222000000000000000000200000000000000000000002
44444444006260000004000000000000000000004444444466666666000000000040000000000400088888000444044400000000200000000000000000000002
44444444000600000004000000000000000000004444444466666666044444400020000000000200088888000000000000000000200000000000000000000002
44444444000300000006000000000000000000000000000000000000044444400024440000444200088888004440444000000400200000000000000000000002
00000000002020000044000000000000000000002222222255099055044444400024440000444200088888000000000000000000200000000000000000000002
66666666002220000066400000000000000000002000000250999905002002000002020000202000020002000444044400000000222222222222222222222222
00533300005555000055550000000000000000000055550000000500000000000000000000000000000000000000000000000000000007770000000000000007
33330055550000555500005555000055550000555500005500005050000000000000000000000000000000000000000000000770000076670000064000000070
00333500000555000076050000050000000550000050000000500000000000000000000000000000000000000000000000007670000767670000666000000700
50033350505110505055076050aa5090507c05505500a05000000000000000000000000000000000000000000007700000076700007676700004666700007000
55003005550115055776500550a9550555cc05055000400505000000000000000000000000000000000000000076700060767000776767000044066706670000
55503300550115005005507050055aa0505007c05500405050500500000000000000000000000000000000000467000006670000467670000440077006460000
0003333000115550057757650a550a9000555cc00050000000000000000000000000000000000000000000000440000004600000046700004400000004060000
03335553051150550505500505050005050555050505550500000000000000000000000000000000000000004000000040060000404700004000000040000000
00660066006666000066660006000660066000666000000000000006000000000000000000000000000000000000000044000000000000000000007700007000
06006600660000666600006060666006600666000000600000060000000000000000000000000000000000000000000040444000044007700000076700000770
60000000000000000000000660000006600000000000000000000000000000000000000000000000000000000444000007000400400420700007767000707670
60066000000000000006600606000060600000000006600000066000000000000000000000000000000000000700400000700040070242000000470000076707
60066060000000000606600606000060600000000606600000066060000000000000000000000000000000000070040000070040007224000004070000077000
06000000000000000000000660000006600000000000000000000000000000000000000000000000000000000007040000007040042700400040000000400700
06006000000000000006000660066006600000660000000000000000000000000000000000000000000000000000740000000704424070400400000004000000
60000000000000000000000666600666066666000000000000000000000000000000000000000000000000000000000000000044240004004000000040000000
06000000005555000000000666666660006666600000000000000000000000000000000000000000000000000670076000000000000000000000000000088000
06000000550000550000000660000006660000060000000000000000000000000000000000000000000000000600006006700760004444000000000000088000
60000000005555000000006006000006000000600000000000000000000000000000000000000000000000000067760066700766046666404440044400777700
60000000500555500000006006000006000000600606600000066060000000000000000000000000000000000077770077077077004004004204402407777770
60000000550000050000006006000006000000600006600000066000000000000000000000000000000000000070070000666600004004000042240000700700
60000000555055000000000660000060000000060000000000000000000000000000000000000000000000000070070000766700000000000042240000700700
06000000000055500000000660000060000066060000600000060000000000000000000000000000000000000000000000766700000000000042240000000000
60000000055005550000000660000006666600606000000000000006000000000000000000000000000000000000000000077000000000000004400000000000
60000000000000000000000660000006006666606000000600555500000000000000000000000000000000000000000000000000000000400000000000000000
60000000000000000006000660000060660000066000000655000000000000000000000000000000000000000000000000777700000004c40000000000000000
0600600000000000000000066000006000000000060000060066660000000000000000000000000000000000007007000066660000004ccc0000044000007700
06000060000000000606606006000060000000000600006056000060000000000000000000000000000000000760067000600600000040c00000744000004700
06066000000000000006600606000006000000000600006056000060000000000000000000000000000000000660066000700700000400000077470000040000
60066000000000000000000660000006000000006000006056000560000000000000000000000000000000000000000000600600004000000780700006400000
60000066000666006600006060000006006666006000000606000060000000000000000000000000000000000000000000000000040000000788700064600000
06666600666000660066660006666660660000666000000606055060000000000000000000000000000000000000000000000000400000000077000006000000
__map__
5455555555555555555555555555555654555555555555555555555555555556545555555555555555555555555555560000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
64959595959595959595959595959566649696969696969696969696960000666496969696000000005d0000000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
649595959595954f9595bbbb95959566649600969696009696969696969600666490919296004d00005d0090919200660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
64959595959595959595bb954f95956664969696964b4949969696969696006664a0a1a07f000000005d00a0a1a07f660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6495959569959595959595959595956664964848964b494996969696969600666496969696004545005d0096969600660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
64959595959595959595959595959566649648969696494996474796000000666496416f96004547007d0096416f00660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6495959595959595959595959595956664969696969696969647000000000066640000000045454500000000000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6495959595959595699569959595959696969696964396969696000000000066640000005052454545000000000000960000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6495959595959595449595959595959696960000004343969696000000000096960000007072000000a200004e6969960000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
649595954f95694243456995954e956664964200000000969696000000000096960069690000000000b26969696900960000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
64bb95959595694145959595959595666496424200960000000000484800969600004e6969684e696969694f000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6495bb9595959595699569954e95956664969600004900000000004800009666640000006900696900000000000000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
649595959595959595959595959595666496960000000000000000000000966664000000006869000043004b4b4b00660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
649595954e95959595959595bbbb95666496000000004c4c0000000000000066645a5b00000000690043434b4b4b00660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
649595959595959595959595bb9595666496000000004c4c00000000000000666400000000000069000000004b4b00660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7475757575759696757575757575757674757575757575969696757575757576747575757575969696757575757575760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000969696000000969600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000009595000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000009595950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000009595950000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
